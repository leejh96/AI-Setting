---
name: code-review
description: Diff(변경분)에 대한 포괄적인 코드 리뷰를 수행합니다. 변경된 코드에서 보안 취약점, 안티 패턴, 품질 문제를 분석합니다. 파일 경로에서 도메인(프론트엔드/백엔드)을 자동으로 감지합니다.
allowed-tools: Bash, Read, Edit, Write, Grep, Glob, Task
---

# 코드 리뷰 스킬

Diff(변경분)에 대해 포괄적인 코드 리뷰를 수행합니다. 당신의 임무는 변경된 코드에서 보안 취약점, 안티 패턴, 품질 문제를 분석하는 것입니다.

## 입력 모델

이 스킬은 호출되기 전에 컨텍스트에 **diff**가 제공될 것을 기대합니다. 호출자는 diff를 생성할 책임이 있습니다.

**호출 예시:**
- 사용자가 PR diff를 붙여넣은 후 `/code-review` 실행
- 에이전트가 `git diff HEAD~1`을 실행한 후 이 스킬 호출
- CI 도구가 리뷰를 위해 diff 내용을 제공

컨텍스트에 diff가 없는 경우, 사용자에게 제공해달라고 요청하거나 생성할 것을 제안하세요 (예: `git diff`, `git diff main..HEAD`).

---

## 도메인 감지

diff 내의 디렉토리 경로를 기반으로 적용할 체크리스트를 자동 감지합니다:

| 디렉토리 | 도메인 | 체크리스트 |
|-----------|--------|-----------|
| `designer/` | 프론트엔드 | `frontend.md` 읽기 |
| `server/` | 백엔드 | `backend.md` 읽기 |
| `rag/` | 백엔드 | `backend.md` 읽기 |
| `runtimes/universal/` | 백엔드 | `backend.md` 읽기 |
| `cli/` | CLI/Go | 일반적인 체크만 수행 |
| `config/` | Config | 일반적인 체크만 수행 |

diff가 여러 도메인에 걸쳐 있는 경우, 관련된 모든 체크리스트를 로드하세요.

---

## 리뷰 프로세스

### 1단계: Diff 파싱

diff에서 다음을 추출합니다:
- 변경된 파일 목록
- 변경된 라인 (추가 및 수정)
- 파일 경로에 따른 감지된 도메인

### 2단계: 리뷰 문서 초기화

**임시 파일 패턴(temp-files pattern)**을 사용하여 리뷰 문서를 생성합니다:

```bash
REPORT_DIR="docs/code-review"
mkdir -p "$REPORT_DIR"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
FILEPATH="${REPORT_DIR}/code-review-${TIMESTAMP}.md"
```

다음 스키마로 초기화합니다:

```markdown
# 코드 리뷰 리포트

**날짜**: {현재 날짜}
**리뷰어**: 코드 리뷰 에이전트
**소스**: {예: "PR diff", "unstaged changes", "main..HEAD"}
**변경된 파일**: {개수}
**감지된 도메인**: {목록}
**상태**: 진행 중 (In Progress)

## 요약

| 카테고리 | 확인 항목 수 | 통과 | 실패 | 발견 사항 |
|----------|---------------|--------|--------|----------|
| 보안 (Security) | 0 | 0 | 0 | 0 |
| 코드 품질 (Code Quality) | 0 | 0 | 0 | 0 |
| 성능 (Performance) | 0 | 0 | 0 | 0 |
| LLM 코드 스멜 | 0 | 0 | 0 | 0 |
| 영향도 분석 (Impact Analysis) | 0 | 0 | 0 | 0 |
| 단순화 (Simplification) | 0 | 0 | 0 | 0 |
| {감지된 도메인에 따른 추가 카테고리}

## 상세 발견 사항

{리뷰가 진행됨에 따라 여기에 발견 사항 추가}
```

### 3단계: 변경된 코드 리뷰

각 체크리스트 항목에 대해:

1. **피드백 범위를 diff 라인으로 한정** - 변경된 코드의 문제만 지적하세요
2. **파일 컨텍스트 사용** - 주변 코드를 이해하기 위해 전체 파일 내용을 읽으세요
3. **관련 체크 적용** - 도메인에 적합한 체크리스트 항목을 사용하세요
4. **발견 사항 문서화** - 변경된 코드에서 발견된 각 위반 사항을 기록하세요

**핵심 원칙**: 리뷰 대상은 **diff**입니다. 파일의 나머지 부분은 정확한 리뷰를 위한 컨텍스트를 제공할 뿐입니다.

### 4단계: 영향도 분석

diff가 코드베이스의 다른 부분에 영향을 줄 수 있는지 확인합니다:

- **변경된 export/인터페이스** - 깨질 수 있는 다른 곳의 사용처 검색
- **수정된 API 시그니처** - 업데이트가 필요한 호출자(caller) 확인
- **변경된 공유 유틸리티** - 영향을 받을 수 있는 소비자(consumer) 확인
- **설정/스키마 변경** - 이전 구조에 의존하는 코드 찾기

설명되지 않은 영향이 발견되면 위험도에 따라 심각도를 지정하여 발견 사항으로 보고하세요.

### 5단계: 각 발견 사항 문서화

발견된 각 문제에 대해 항목을 추가합니다:

```markdown
### [{카테고리}] {항목 이름}

**상태**: 실패 (FAIL)
**심각도**: Critical | High | Medium | Low
**범위**: 변경된 코드 | 영향도 분석

#### 위반 사항

- **파일**: `path/to/file.ext`
- **라인**: 42-48 (diff 기준)
- **코드**:
```
// diff에서 가져온 문제의 코드 스니펫
```
- **문제점**: {무엇이 잘못되었는지 설명}
- **권장 사항**: {해결 방법}
```

### 6단계: 리포트 마무리

모든 체크를 완료한 후:

1. 요약 테이블을 최종 카운트로 업데이트
2. 경영진 요약(Executive Summary) 추가:
   - 총 발견 문제 수
   - 즉각적인 주의가 필요한 중요(Critical) 문제
   - 영향도 분석 결과
   - 권장 수정 우선순위
3. 상태를 "완료(Complete)"로 업데이트
4. 사용자에게 리포트 위치 알림

---

## 일반 리뷰 카테고리

이 체크들은 도메인과 관계없이 **모든** 변경된 코드에 적용됩니다.

---

## 카테고리: 보안 기초 (Security Fundamentals)

### 하드코딩된 비밀 (Hardcoded Secrets)

**diff 확인**:
- 변경된 코드 내의 API 키, 비밀번호, 시크릿
- 패턴: `api_key`, `apiKey`, `password`, `secret`, `token`, `credential`과 리터럴 값

**통과 기준**: diff 내에 하드코딩된 비밀이 없음 (환경 변수 사용해야 함)
**심각도**: Critical

---

### Eval 및 동적 코드 실행

**diff 확인**:
- JavaScript/TypeScript: `eval(`, `new Function(`, `setTimeout("`, `setInterval("`
- Python: `eval(`, `exec(`, `compile(`

**통과 기준**: 변경된 라인에 동적 코드 실행이 없음
**심각도**: Critical

---

### 커맨드 인젝션 (Command Injection)

**diff 확인**:
- Python: `subprocess`와 `shell=True`, `os.system(`
- Go: 검증되지 않은 입력을 사용하는 `exec.Command(`

**통과 기준**: 쉘 커맨드에 검증되지 않은 사용자 입력이 없음
**심각도**: Critical

---

## 카테고리: 코드 품질 (Code Quality)

### 콘솔/프린트 문 (Console/Print Statements)

**diff 확인**:
- JavaScript/TypeScript: `console.log`, `console.debug`, `console.info`
- Python: `print(` 문

**통과 기준**: 프로덕션 코드 변경에 디버그 문이 없음
**심각도**: Low

---

### TODO/FIXME 주석

**diff 확인**:
- `TODO:`, `FIXME:`, `HACK:`, `XXX:` 주석

**통과 기준**: 새로운 TODO는 이슈로 추적되어야 함
**심각도**: Low

---

### 빈 Catch/Except 블록

**diff 확인**:
- JavaScript/TypeScript: `catch { }` 또는 `catch(e) { }`
- Python: `except: pass` 또는 빈 except 블록

**통과 기준**: 모든 에러 핸들러는 로그를 남기거나 다시 던져야(rethrow) 함
**심각도**: High

---

## 카테고리: 성능 (Performance)

### N+1 쿼리 문제

**diff 확인**:
- 반복문 내에서 데이터베이스 쿼리 실행
- ORM에서 관계(relation)를 lazy loading하는 패턴
- 예: `for item in items: db.query(item.id)`

**통과 기준**: 쿼리가 배치 처리되거나 eager loading 사용
**심각도**: High
**제안**: `IN` 쿼리, `join`, 또는 ORM의 `include`/`with` 사용

---

### 비효율적인 알고리즘

**diff 확인**:
- 중첩 반복문 (O(n²) 복잡도)
- 불필요한 정렬 또는 필터링
- 같은 계산의 반복 수행

**통과 기준**: 효율적인 알고리즘 사용 (적절한 시간 복잡도)
**심각도**: Medium
**제안**: 해시맵, Set, 메모이제이션 활용

---

### 캐싱 기회

**diff 확인**:
- 변경되지 않는 데이터를 반복적으로 조회
- 외부 API 호출을 매번 수행
- 계산 비용이 높은 작업의 반복

**통과 기준**: 적절한 캐싱 전략 적용
**심각도**: Medium
**제안**: Redis, 메모리 캐시, 또는 메모이제이션 사용

---

### 메모리 누수 가능성

**diff 확인**:
- JavaScript/TypeScript: 클로저 내 대용량 객체 참조
- Python: 순환 참조, 전역 변수에 대량 데이터 저장
- 이벤트 리스너 미해제

**통과 기준**: 메모리 관리가 적절함
**심각도**: High
**제안**: 적절한 정리(cleanup), weak reference 사용

---

### 불필요한 API/네트워크 호출

**diff 확인**:
- 동일한 데이터를 여러 번 요청
- 병렬 처리 가능한 호출을 순차적으로 실행
- 필요 이상의 데이터 요청

**통과 기준**: API 호출이 최적화됨
**심각도**: Medium
**제안**: 배치 요청, 병렬 처리 (`Promise.all`, `asyncio.gather`), 필요한 필드만 요청

---

### 비동기 처리 기회

**diff 확인**:
- I/O 작업을 동기적으로 실행 (파일 읽기, API 호출)
- 블로킹 작업으로 인한 성능 저하
- 병렬 처리 가능한 작업의 순차 실행

**통과 기준**: I/O 작업이 비동기로 처리됨
**심각도**: Medium
**제안**: `async/await`, `Promise.all`, 워커 스레드 활용

---

## 카테고리: LLM 코드 스멜

### 플레이스홀더 구현 (Placeholder Implementations)

**diff 확인**:
- `TODO`, `PLACEHOLDER`, `IMPLEMENT`, `NotImplemented`
- 단순히 `return None`, `return []`, `return {}`만 하는 함수

**통과 기준**: 프로덕션 코드에 플레이스홀더 구현이 없음
**심각도**: High

---

### 지나치게 일반화된 추상화 (Overly Generic Abstractions)

**diff 확인**:
- `GenericHandler`, `BaseManager`, `AbstractFactory`와 같은 이름의 새 클래스/함수
- 명확한 재사용 정당성이 없는 추상화

**통과 기준**: 추상화가 실제 재사용에 의해 정당화됨
**심각도**: Low

---

## 카테고리: 영향도 분석 (Impact Analysis)

### 변경 (Breaking Changes)

**diff가 다음을 수정하는지 확인**:
- 내보내진(Exported) 함수/클래스 - 다른 곳에서 import 검색
- API 엔드포인트 - 호출자(caller) 검색
- 공유 타입/인터페이스 - 사용처 검색
- 설정 스키마 - 소비자(consumer) 검색

**통과 기준**: 모든 영향을 받는 코드가 식별되고 설명됨
**심각도**: High (설명되지 않은 영향 발견 시)

---

## 카테고리: 단순화 (Simplification)

### 중복 로직 (Duplicate Logic)

**diff 확인**:
- 반복되는 코드 패턴 (단순 문법적 유사성 제외)
- 약간의 변형만 있는 복사-붙여넣기 코드
- 유사한 유효성 검사, 변환 또는 포맷팅 로직

**통과 기준**: 변경된 코드에 명백한 중복이 없음
**심각도**: Medium
**제안**: 공유 로직을 재사용 가능한 함수로 추출

---

### 불필요한 복잡성 (Unnecessary Complexity)

**diff 확인**:
- 깊게 중첩된 조건문 (3단계 이상)
- 관련 없는 여러 작업을 수행하는 함수
- 지나치게 복잡한 제어 흐름

**통과 기준**: 코드가 합리적으로 평탄(flat)하고 집중되어 있음
**심각도**: Medium
**제안**: 조기 반환(early return) 사용, 헬퍼 함수 추출

---

### 장황한 패턴 (Verbose Patterns)

**diff 확인**:
- 언어에 더 간단한 대안이 있는 패턴
- 불필요한 null 체크 또는 타입 단언(assertion)
- 불필요한 중간 변수

**통과 기준**: 관용적(idiomatic) 패턴 사용
**심각도**: Low
**제안**: 언어 내장 기능 사용하여 단순화

---

## 도메인별 리뷰 항목

감지된 도메인에 따라 적절한 체크리스트를 읽고 적용합니다:

- **프론트엔드 감지됨** (`designer/`): `frontend.md`를 읽고 변경된 코드에 해당 체크 적용
- **백엔드 감지됨** (`server/`, `rag/`, `runtimes/`): `backend.md`를 읽고 변경된 코드에 해당 체크 적용

---

## 최종 요약 템플릿

```markdown
## 경영진 요약 (Executive Summary)

**리뷰 완료**: {timestamp}
**총 발견 사항**: {count}

### 중요 문제 (반드시 수정)
1. {문제 1}
2. {문제 2}

### 영향도 분석 결과
- {파괴적 변경 또는 설명되지 않은 영향에 대한 요약}

### 높은 우선순위 (수정 권장)
1. {문제 1}
2. {문제 2}

### 권장 사항
{검토된 변경 사항에 대한 전반적인 권장 사항}
```

---

## 에이전트를 위한 참고사항

1. **범위를 diff로 한정**: 변경된 라인의 문제만 지적하세요. 변경되지 않은 코드는 리뷰하지 마세요.

2. **컨텍스트 사용**: 변경 사항을 이해하기 위해 전체 파일을 읽되, 피드백은 diff만을 대상으로 합니다.

3. **영향 확인**: 변경 사항이 export, API 또는 공유 코드를 건드리면 영향을 받는 소비자를 검색하세요.

4. **구체적으로 작성**: 모든 발견 사항에 대해 파일 경로, 라인 번호(diff 기준), 코드 스니펫을 포함하세요.

5. **우선순위 지정**: 중요한 보안 문제는 즉시 플래그 지정하세요.

6. **솔루션 제공**: 각 발견 사항에는 수정 방법에 대한 권장 사항을 포함해야 합니다.

7. **점진적 업데이트**: 리뷰 문서 마지막이 아니라 각 카테고리 완료 후 문서를 업데이트하세요.
